---
- name: Setup alternative K3s directory
  when:
    - k3s_server_location is defined
    - k3s_server_location != "/var/lib/rancher/k3s"
  block:
    - name: Make rancher directory
      ansible.builtin.file:
        path: /var/lib/rancher
        mode: "0755"
        state: directory
    - name: Create symlink
      ansible.builtin.file:
        dest: /var/lib/rancher/k3s
        src: "{{ k3s_server_location }}"
        force: true
        state: link

- name: Setup extra manifests
  when: extra_manifests is defined
  block:
    - name: Make manifests directory
      ansible.builtin.file:
        path: /var/lib/rancher/k3s/server/manifests
        mode: "0700"
        state: directory
    - name: Copy manifests
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /var/lib/rancher/k3s/server/manifests
        mode: "0600"
      loop: "{{ extra_manifests }}"

- name: Setup optional config file
  when: config_yaml is defined
  block:
    - name: Make config directory
      ansible.builtin.file:
        path: /etc/rancher/k3s
        mode: "0755"
        state: directory
    - name: Copy config values
      ansible.builtin.copy:
        content: "{{ config_yaml }}"
        dest: /etc/rancher/k3s/config.yaml
        mode: "0644"
